<script type="text/javascript">

  google.charts.load('current', { packages: ['corechart', 'line'] });
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {

    var user_results = JSON.parse('<%= (@user_results_json.count) == 0 ? "[]" : @user_results_json.to_json.html_safe %>');
    console.log(user_results);

    var dates = new Set();
    user_results.forEach(function (user_result) {
      user_result.phone_usages.forEach(function (phone_usage) {
        var start_time = new Date(phone_usage.start_time)
        dates.add(dateToString(start_time))
      });
    });

    var results = {};
    user_results.forEach(function (user_result) {
      user_result.phone_usages.forEach(function (phone_usage) {
        var start_time = new Date(phone_usage.start_time)
        var end_time = new Date(phone_usage.end_time)
        var time_spent_in_minutes = (end_time - start_time) / 60000

        var start_time_string = dateToString(start_time)
        if (start_time_string in results) {
          results[start_time_string] += time_spent_in_minutes;
        } else {
          results[start_time_string] = time_spent_in_minutes;
        }
      });
    });

    var data = new google.visualization.DataTable();
    data.addColumn('date', 'X');
    data.addColumn('number', 'Time Spent On Phone in Minutes');


    dates = Array.from(dates).sort();
    console.log(dates)
    console.log(results)
    dates.forEach(function (date) {
      data.addRow([new Date(date), results[date]]);
    });
    if (dates.length === 1) {
      data.addRow([(new Date(new Date().getTime() + (24 * 60 * 60 * 1000))), 0]);
    }
    console.log(data)

    var options = {
      vAxis: {
        title: 'Time Spent On Phone in Minutes'
      },
      hAxis: {
        title: 'Date'
      },
      width: 800,
      height: 500,
      pointSize: 10,
      backgroundColor: '#f1f8e9'
    };

    var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

    chart.draw(data, options);
  }

  function dateToString(date) {
    return date.getMonth().toString() + "-" + date.getDate().toString() + "-" + date.getFullYear().toString()
  }
</script>

<%= link_to 'Back', user_results_path, :class => "mdl-button mdl-js-button mdl-button--accent" %><br><br>
<strong>User UUID:</strong>
<%= params[:user_uuid] %>
<div>
  <%= content_tag :div, '', id: 'user-result-data', data: @user_result_data %>
  <div id="chart_div"></div>
</div>

<h2>Phone Usage Micro Intervals</h2><br>
<table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp fixed_header" style="width: 410px">
  <thead>
    <tr>
      <th class="mdl-data-table__cell--non-numeric">Period Start</th>
      <th class="mdl-data-table__cell--non-numeric">Period End</th>
    </tr>
  </thead>
  <tbody>
    <% @phone_usage_micro_intervals.each do |micro_interval| %>
    <tr>
      <td class="mdl-data-table__cell--non-numeric"><%= micro_interval.start_time %></td>
      <td class="mdl-data-table__cell--non-numeric"><%= micro_interval.end_time %></td>
    </tr>
    <% end %>
  </tbody>
</table>

<h2>User Results</h2><br>
<table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp fixed_header" style="width: 500px">
  <thead>
    <tr>
      <th class="mdl-data-table__cell--non-numeric">Period Start</th>
      <th class="mdl-data-table__cell--non-numeric">Period End</th>
      <th class="mdl-data-table__cell--non-numeric">Survey Result</th>
    </tr>
  </thead>
  <tbody>
    <% @user_results.each do |user_result| %>
    <tr>
      <td class="mdl-data-table__cell--non-numeric"><%= user_result.period_start %></td>
      <td class="mdl-data-table__cell--non-numeric"><%= user_result.period_end %></td>
      <td class="mdl-data-table__cell--non-numeric">
        <%= link_to user_result.survey_result_id, survey_result_path(user_result.survey_result_id) %>
      </td>
    </tr>
    <% end %>
  </tbody>
</table><br>